import { readdirSync, readFileSync, writeFileSync } from 'fs';
import { join } from 'path';

/**
 * esbuild plugin to auto-discover and register components
 * Scans src/components/ and generates src/components.register.ts
 */
export const autoRegisterComponents = {
	name: 'auto-register-components',
	setup(build) {
		// Run once at the start of the build
		build.onStart(() => {
			// Discover all component files
			const components = discoverComponents();

			// Filter out disabled components
			const enabledComponents = components.filter(c => c.enabled !== false);

			// Generate import statements
			const imports = enabledComponents.map(c =>
				`import { ${c.exportName} } from "components/${c.importPath}";`
			).join('\n');

			// Generate COMPONENTS array
			const componentsArray = `export const COMPONENTS: Component<readonly string[]>[] = [\n\t${
				enabledComponents.map(c => c.exportName).join(',\n\t')
			}\n];`;

			// Generate the complete file content
			const fileContent = `// AUTO-GENERATED FILE - DO NOT EDIT
// This file is automatically generated by scripts/auto-register-plugin.mjs
// To add/remove components, create/delete files in src/components/
// To disable a component, set enabled: false in the component definition

import { Component } from "./components";

${imports}

${componentsArray}
`;

			// Write to src/components.register.ts
			writeFileSync('src/components.register.ts', fileContent);

			console.log(`[auto-register] Generated components.register.ts with ${enabledComponents.length} enabled components`);
			if (components.length !== enabledComponents.length) {
				const disabled = components.filter(c => c.enabled === false);
				console.log(`[auto-register] Disabled: ${disabled.map(c => c.exportName).join(', ')}`);
			}
		});
	}
};

/**
 * Scan src/components/ directory and discover all component files
 */
function discoverComponents() {
	const componentsDir = 'src/components';
	const entries = readdirSync(componentsDir, { withFileTypes: true });
	const components = [];

	for (const entry of entries) {
		if (!entry.isDirectory()) continue;

		const dirPath = join(componentsDir, entry.name);
		const files = readdirSync(dirPath);

		// Find .ts files (excluding styles.ts)
		for (const file of files) {
			if (!file.endsWith('.ts') || file === 'styles.ts') continue;

			const filePath = join(dirPath, file);
			const content = readFileSync(filePath, 'utf-8');

			// Extract the exported component name
			// Look for: export const componentName: Component = { ... }
			const match = content.match(/export\s+const\s+(\w+)\s*:\s*Component/);
			if (match) {
				const exportName = match[1];
				const importPath = `${entry.name}/${file.replace('.ts', '')}`;

				// Check if component has enabled: false
				// Look for 'enabled: false' within the component object
				const enabledMatch = content.match(/enabled\s*:\s*(true|false)/);
				const enabled = enabledMatch ? enabledMatch[1] === 'true' : true; // Default to true

				components.push({
					exportName,
					importPath,
					dirName: entry.name,
					fileName: file,
					enabled
				});
			}
		}
	}

	// Sort by export name for consistency
	return components.sort((a, b) => a.exportName.localeCompare(b.exportName));
}
