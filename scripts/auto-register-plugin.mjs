import { readdirSync, readFileSync, writeFileSync, watch } from 'fs';
import { join } from 'path';

let lastGenerated = '';

/**
 * Scan src/components/ directory and discover all component files
 */
function discoverComponents() {
	const componentsDir = 'src/components';
	const entries = readdirSync(componentsDir, { withFileTypes: true });
	const components = [];

	for (const entry of entries) {
		if (!entry.isDirectory()) continue;

		const dirPath = join(componentsDir, entry.name);
		const files = readdirSync(dirPath);

		// Find .ts files (excluding styles.ts and settingsStyles.ts)
		for (const file of files) {
			if (!file.endsWith('.ts') || file.includes('styles.ts') || file.includes('Styles.ts')) continue;

			const filePath = join(dirPath, file);
			const content = readFileSync(filePath, 'utf-8');

			// Extract the exported component name
			const match = content.match(/export\s+const\s+(\w+)\s*:\s*Component/);
			if (match) {
				const exportName = match[1];
				const importPath = `${entry.name}/${file.replace('.ts', '')}`;

				// Check if component has enabled: false
				const enabledMatch = content.match(/enabled\s*:\s*(true|false)/);
				const enabled = enabledMatch ? enabledMatch[1] === 'true' : true;

				components.push({
					exportName,
					importPath,
					dirName: entry.name,
					fileName: file,
					enabled
				});
			}
		}
	}

	return components.sort((a, b) => a.exportName.localeCompare(b.exportName));
}

export function generateRegisterFile() {
	const components = discoverComponents();
	const enabledComponents = components.filter(c => c.enabled !== false);

	const imports = enabledComponents.map(c =>
		`import { ${c.exportName} } from "components/${c.importPath}";`
	).join('\n');

	const componentsArray = `export const COMPONENTS: Component<readonly string[]>[] = [\n\t${
		enabledComponents.map(c => c.exportName).join(',\n\t')
	}\n];`;

	const fileContent = `// AUTO-GENERATED FILE - DO NOT EDIT
// This file is automatically generated by scripts/auto-register-plugin.mjs
// To add/remove components, create/delete files in src/components/
// To disable a component, set enabled: false in the component definition

import { Component } from "./components";

${imports}

${componentsArray}
`;

	// Only write if content changed
	if (fileContent !== lastGenerated) {
		lastGenerated = fileContent;
		writeFileSync('src/components.register.ts', fileContent);
		console.log(`[auto-register] Generated components.register.ts with ${enabledComponents.length} enabled components`);
		if (components.length !== enabledComponents.length) {
			const disabled = components.filter(c => c.enabled === false);
			console.log(`[auto-register] Disabled: ${disabled.map(c => c.exportName).join(', ')}`);
		}
		return true;
	}
	return false;
}

/**
 * esbuild plugin to auto-discover and register components
 */
export const autoRegisterComponents = {
	name: 'auto-register-components',
	setup(build) {
		const isWatch = build.initialOptions.watch || process.argv.includes('--watch');

		build.onStart(() => {
			generateRegisterFile();
		});

		// In watch mode, detect new components automatically
		if (isWatch) {
			let debounceTimer = null;

			watch('src/components', { recursive: true }, (eventType, filename) => {
				if (filename && (filename.endsWith('.ts') || eventType === 'rename')) {
					if (debounceTimer) clearTimeout(debounceTimer);
					debounceTimer = setTimeout(() => generateRegisterFile(), 100);
				}
			});
		}
	}
};
